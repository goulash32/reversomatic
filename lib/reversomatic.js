"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var gf=require("gif-frames"),ge=require("gifencoder"),pfs=require("png-file-stream"),gify_parse_1=require("gify-parse"),Stopwatch=require("elapsed-time"),rimraf=require("rimraf"),path_1=require("path"),fs_1=require("fs"),timers_1=require("timers"),GifReverseResult=function(){return function(path,frameDelay,duration,processTime){this.path=path,this.frameDelay=frameDelay,this.duration=duration,this.processTime=processTime}}(),Reversomatic=function(){function Reversomatic(tempDirectory,outputDirectory,maxDurationInMilliseconds,maxSizeInMegabytes){void 0===maxDurationInMilliseconds&&(maxDurationInMilliseconds=3e4),void 0===maxSizeInMegabytes&&(maxSizeInMegabytes=0),this.tempDirectory=tempDirectory||"./temp",this.outputDirectory=outputDirectory||"./output",this.maxDurationInMilliseconds=maxDurationInMilliseconds,this.maxSizeInBytes=1e6*maxSizeInMegabytes,this.verifyAndCreateDirs()}return Reversomatic.prototype.processGif=function(inputFilename,outputFilename,options,callback){var _this=this;timers_1.setTimeout(function(){var gifFile,stopwatch=Stopwatch.new();stopwatch.start();try{gifFile=fs_1.readFileSync(inputFilename)}catch(err){return callback(err,null)}var gifInfo=gify_parse_1.getInfo(gifFile),fileInfo=fs_1.statSync(inputFilename);if(!gifInfo.valid)return callback(Error("Invalid GIF file."),null);var numFrames=gifInfo.images.length,gifDuration=gifInfo.duration,gifFrameDelay=(fileInfo.size,0);if(gifDuration>_this.maxDurationInMilliseconds)return callback(Error("GIF duration longer than max duration.\n"+_this.maxDurationInMilliseconds+" ms."),null);if(0!=_this.maxSizeInBytes&&fileInfo.size>_this.maxSizeInBytes)return callback(Error("Input GIF file size is larger than max file size.\nMax Size: "+_this.maxSizeInBytes/1e6+" MB\nActual Size: "+fileInfo.size/1e6+" MB"));if(options.averageFrameDelay){for(var _i=0,_a=gifInfo.images;_i<_a.length;_i++){var img=_a[_i];gifFrameDelay+=img.delay}(gifFrameDelay=Math.floor(gifFrameDelay/numFrames))*numFrames}else(gifFrameDelay=gifInfo.images[0].delay)*numFrames;options.forcedFrameDelay;var tempFolderPfx=path_1.join(_this.tempDirectory,"processGif");fs_1.mkdtemp(tempFolderPfx,"utf8",function(err,folder){if(err)return callback(Error("Unable to create temporary directory for gif: "+err.message),null);gf({url:inputFilename,frames:"all",outputType:"png",cumulative:!0}).then(function(frames){var imgPrefix=path_1.join(folder,"image");_this.chainProcessImages(frames,frames.length-1,imgPrefix,function(){var encoder=new ge(gifInfo.width,gifInfo.height),ws=fs_1.createWriteStream(path_1.join(_this.outputDirectory,outputFilename)),globChars=Array(_this.getFrameCountDigits(frames)+1).join("?");pfs(imgPrefix+globChars+".png").pipe(encoder.createWriteStream({delay:gifFrameDelay,repeat:0,quality:100})).pipe(ws),ws.on("finish",function(){rimraf(folder,function(err){if(err)return callback(Error("Unable to remove temporary folder "+folder+"."),null);var fullPath=path_1.join(_this.outputDirectory,outputFilename),processTime=stopwatch.getValue();return callback(null,new GifReverseResult(fullPath,gifFrameDelay,gifDuration,processTime))})}),ws.on("error",function(){rimraf(folder,function(err){return callback(Error("Unable to write reversed GIF to "+outputFilename+"."),null)})})})})})},10)},Reversomatic.prototype.verifyAndCreateDirs=function(){var _this=this;fs_1.exists(this.tempDirectory,function(ex){ex||fs_1.mkdirSync(_this.tempDirectory),fs_1.exists(_this.outputDirectory,function(ex){ex||fs_1.mkdirSync(_this.outputDirectory)})})},Reversomatic.prototype.getFrameCountDigits=function(frames){return Math.log(frames.length)*Math.LOG10E+1|0},Reversomatic.prototype.chainProcessImages=function(frames,index,filePrefix,callback){var _this=this;if(index<0)return callback();var frameCountDigits=this.getFrameCountDigits(frames),frameIndex=(Array(frameCountDigits+1).join("0")+index).slice(-frameCountDigits),element=frames[frames.length-index-1],filename=""+filePrefix+frameIndex+".png",wstr=fs_1.createWriteStream(filename);wstr.on("finish",function(){_this.chainProcessImages(frames,--index,filePrefix,callback)}),wstr.on("open",function(){element.getImage().pipe(wstr)})},Reversomatic}();exports.Reversomatic=Reversomatic;