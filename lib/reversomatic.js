"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var gf=require("gif-frames"),ge=require("gifencoder"),pfs=require("png-file-stream"),gify_parse_1=require("gify-parse"),rimraf=require("rimraf"),path_1=require("path"),fs_1=require("fs"),GifReverseResult=function(){return function(r,e,t){this.path=r,this.frameRate=e,this.duration=t}}(),Reversomatic=function(){function r(r,e,t){void 0===t&&(t=3e4);var i=this;this.chainProcessImages=function(r,e,t,n){if(e<0)return n();var o=i.getFrameCountDigits(r),a=(Array(o+1).join("0")+e).slice(-o),u=r[r.length-e-1],s=""+t+a+".png",f=fs_1.createWriteStream(s);f.on("finish",function(){i.chainProcessImages(r,--e,t,n)}),f.on("open",function(){u.getImage().pipe(f)})},this.tempDirectory=r||"./temp",this.outputDirectory=e||"./output",this.maxDuration=t,this.verifyAndCreateDirs()}return r.prototype.processGif=function(r,e,t,i){var n,o=this;try{n=fs_1.readFileSync(r)}catch(r){return i(r,null)}var a=gify_parse_1.getInfo(n);if(!a.valid)return i(Error("Invalid GIF file."),null);var u,s=a.isBrowserDuration?a.duration:a.duration/10;if(u=t.averageFrameDuration?s/a.images.length:a.images[0].delay,s>this.maxDuration)return i(Error("GIF duration longer than max duration of "+this.maxDuration+" milliseconds."),null);var f=path_1.join(this.tempDirectory,"processGif");fs_1.mkdtemp(f,"utf8",function(t,n){if(t)return i(Error("Unable to create temporary directory for gif: "+t.message),null);gf({url:r,frames:"all",outputType:"png",cumulative:!0}).then(function(r){var t=path_1.join(n,"image");o.chainProcessImages(r,r.length-1,t,function(){var f=new ge(a.width,a.height),c=fs_1.createWriteStream(path_1.join(o.outputDirectory,e)),p=Array(o.getFrameCountDigits(r)+1).join("?");pfs(t+p+".png").pipe(f.createWriteStream({delay:u,repeat:0,quality:100})).pipe(c),c.on("finish",function(){rimraf(n,function(r){if(r)return i(Error("Unable to remove temporary folder "+n+"."),null);var t=path_1.join(o.outputDirectory,e);return i(null,new GifReverseResult(t,u,s))})}),c.on("error",function(){rimraf(n,function(r){return i(Error("Unable to write reversed GIF to "+e+"."),null)})})})})})},r.prototype.verifyAndCreateDirs=function(){var r=this;fs_1.exists(this.tempDirectory,function(e){e||fs_1.mkdirSync(r.tempDirectory),fs_1.exists(r.outputDirectory,function(e){e||fs_1.mkdirSync(r.outputDirectory)})})},r.prototype.getFrameCountDigits=function(r){return Math.log(r.length)*Math.LOG10E+1|0},r}();exports.Reversomatic=Reversomatic;