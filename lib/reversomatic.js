"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var gf=require("gif-frames"),ge=require("gifencoder"),pfs=require("png-file-stream"),gify_parse_1=require("gify-parse"),rimraf=require("rimraf"),path_1=require("path"),fs_1=require("fs"),timers_1=require("timers"),GifReverseResult=function(){return function(e,r,t){this.path=e,this.frameRate=r,this.duration=t}}(),Reversomatic=function(){function e(e,r,t){void 0===t&&(t=3e4);var i=this;this.chainProcessImages=function(e,r,t,n){if(r<0)return n();var o=i.getFrameCountDigits(e),a=(Array(o+1).join("0")+r).slice(-o),u=e[e.length-r-1],s=""+t+a+".png",f=fs_1.createWriteStream(s);f.on("finish",function(){i.chainProcessImages(e,--r,t,n)}),f.on("open",function(){u.getImage().pipe(f)})},this.tempDirectory=e||"./temp",this.outputDirectory=r||"./output",this.maxDuration=t,this.verifyAndCreateDirs()}return e.prototype.processGif=function(e,r,t,i){var n=this;timers_1.setTimeout(function(){var o;try{o=fs_1.readFileSync(e)}catch(e){return i(e,null)}var a=gify_parse_1.getInfo(o);if(!a.valid)return i(Error("Invalid GIF file."),null);var u=a.duration,s=0;if(t.averageFrameDuration){for(var f=0,c=a.images;f<c.length;f++){var p=c[f];s+=p.delay}s/=a.images.length}else s=a.images[0].delay;if(u>n.maxDuration)return i(Error("GIF duration longer than max duration of "+n.maxDuration+" milliseconds."),null);var m=path_1.join(n.tempDirectory,"processGif");fs_1.mkdtemp(m,"utf8",function(t,o){if(t)return i(Error("Unable to create temporary directory for gif: "+t.message),null);gf({url:e,frames:"all",outputType:"png",cumulative:!0}).then(function(e){var t=path_1.join(o,"image");n.chainProcessImages(e,e.length-1,t,function(){var f=new ge(a.width,a.height),c=fs_1.createWriteStream(path_1.join(n.outputDirectory,r)),p=Array(n.getFrameCountDigits(e)+1).join("?");pfs(t+p+".png").pipe(f.createWriteStream({delay:s,repeat:0,quality:100})).pipe(c),c.on("finish",function(){rimraf(o,function(e){if(e)return i(Error("Unable to remove temporary folder "+o+"."),null);var t=path_1.join(n.outputDirectory,r);return i(null,new GifReverseResult(t,s,u))})}),c.on("error",function(){rimraf(o,function(e){return i(Error("Unable to write reversed GIF to "+r+"."),null)})})})})})},10)},e.prototype.verifyAndCreateDirs=function(){var e=this;fs_1.exists(this.tempDirectory,function(r){r||fs_1.mkdirSync(e.tempDirectory),fs_1.exists(e.outputDirectory,function(r){r||fs_1.mkdirSync(e.outputDirectory)})})},e.prototype.getFrameCountDigits=function(e){return Math.log(e.length)*Math.LOG10E+1|0},e}();exports.Reversomatic=Reversomatic;