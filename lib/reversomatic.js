"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var gf=require("gif-frames"),ge=require("gifencoder"),pfs=require("png-file-stream"),gify_parse_1=require("gify-parse"),Stopwatch=require("elapsed-time"),rimraf=require("rimraf"),path_1=require("path"),fs_1=require("fs"),timers_1=require("timers"),GifReverseResult=function(){return function(path,frameDelay,duration,processTime){this.path=path,this.frameDelay=frameDelay,this.duration=duration,this.processTime=processTime}}(),Reversomatic=function(){function Reversomatic(tempDirectory,outputDirectory,maxDurationInMilliseconds,maxSizeInMegabytes){void 0===maxDurationInMilliseconds&&(maxDurationInMilliseconds=3e4),void 0===maxSizeInMegabytes&&(maxSizeInMegabytes=0),this.tempDirectory=tempDirectory||"./temp",this.outputDirectory=outputDirectory||"./output",this.maxDurationInMilliseconds=maxDurationInMilliseconds,this.maxSizeInBytes=1e6*maxSizeInMegabytes,this._verifyAndCreateDirs()}return Reversomatic.prototype.processGif=function(inputFilename,outputFilename,options,callback){var _this=this;timers_1.setTimeout(function(){_this._processGif(inputFilename,outputFilename,options,callback)},0)},Reversomatic.prototype._processGif=function(inputFilename,outputFilename,options,callback){var _this=this;try{var stopwatch_1=Stopwatch.new();stopwatch_1.start(),fs_1.readFile(inputFilename,function(err,gifFile){_this._fileLoaded(stopwatch_1,err,gifFile,inputFilename,outputFilename,options,callback)})}catch(err){return callback(err,null)}},Reversomatic.prototype._fileLoaded=function(stopwatch,err,gifFile,inputFilename,outputFilename,options,callback){var _this=this,gifInfo=gify_parse_1.getInfo(gifFile);fs_1.stat(inputFilename,function(err,fileInfo){_this._finishFile(stopwatch,err,fileInfo,gifInfo,inputFilename,outputFilename,options,callback)})},Reversomatic.prototype._finishFile=function(stopwatch,err,fileInfo,gifInfo,inputFilename,outputFilename,options,callback){var _this=this;if(err)return callback(err,null);if(!gifInfo.valid)return callback(Error("Invalid GIF file."),null);var numFrames=gifInfo.images.length,gifDuration=gifInfo.duration,finalDuration=0,gifFrameDelay=(fileInfo.size,0);if(gifDuration>this.maxDurationInMilliseconds)return callback(Error("GIF duration longer than max duration.\nMax Duration: "+this.maxDurationInMilliseconds+" ms.\nActual Duration: "+gifDuration),null);if(0!=this.maxSizeInBytes&&fileInfo.size>this.maxSizeInBytes)return callback(Error("Input GIF file size is larger than max file size.\nMax Size: "+this.maxSizeInBytes/1e6+" MB\nActual Size: "+fileInfo.size/1e6+" MB"));if(options.averageFrameDelay){for(var _i=0,_a=gifInfo.images;_i<_a.length;_i++){var img=_a[_i];gifFrameDelay+=img.delay}gifFrameDelay=Math.floor(gifFrameDelay/numFrames)}else gifFrameDelay=options.forcedFrameDelay?Math.floor(options.forcedFrameDelay):gifInfo.images[0].delay;finalDuration=gifFrameDelay*numFrames;var tempFolderPfx=path_1.join(this.tempDirectory,"processGif");fs_1.mkdtemp(tempFolderPfx,"utf8",function(err,folder){if(err)return callback(Error("Unable to create temporary directory for gif: "+err.message),null);gf({url:inputFilename,frames:"all",outputType:"png",cumulative:!0}).then(function(frames){var imgPrefix=path_1.join(folder,"image");_this._chainProcessImages(frames,frames.length-1,imgPrefix,function(){var encoder=new ge(gifInfo.width,gifInfo.height),ws=fs_1.createWriteStream(path_1.join(_this.outputDirectory,outputFilename)),globChars=Array(_this._getFrameCountDigits(frames)+1).join("?");pfs(imgPrefix+globChars+".png").pipe(encoder.createWriteStream({delay:gifFrameDelay,repeat:0,quality:100})).pipe(ws),ws.on("finish",function(){rimraf(folder,function(err){if(err)return callback(Error("Unable to remove temporary folder "+folder+"."),null);var fullPath=path_1.join(_this.outputDirectory,outputFilename),processTime=stopwatch.getValue();return callback(null,new GifReverseResult(fullPath,gifFrameDelay,finalDuration,processTime))})}),ws.on("error",function(){rimraf(folder,function(err){return callback(Error("Unable to write reversed GIF to "+outputFilename+"."),null)})})})})})},Reversomatic.prototype._verifyAndCreateDirs=function(){var _this=this;fs_1.exists(this.tempDirectory,function(ex){ex||fs_1.mkdirSync(_this.tempDirectory),fs_1.exists(_this.outputDirectory,function(ex){ex||fs_1.mkdirSync(_this.outputDirectory)})})},Reversomatic.prototype._getFrameCountDigits=function(frames){return Math.log(frames.length)*Math.LOG10E+1|0},Reversomatic.prototype._chainProcessImages=function(frames,index,filePrefix,callback){var _this=this;if(index<0)return callback();var frameCountDigits=this._getFrameCountDigits(frames),frameIndex=(Array(frameCountDigits+1).join("0")+index).slice(-frameCountDigits),element=frames[frames.length-index-1],filename=""+filePrefix+frameIndex+".png",wstr=fs_1.createWriteStream(filename);wstr.on("finish",function(){_this._chainProcessImages(frames,--index,filePrefix,callback)}),wstr.on("open",function(){element.getImage().pipe(wstr)})},Reversomatic}();exports.Reversomatic=Reversomatic;